<!--Copyright 2022 The HuggingFace Team. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with
the License. You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->

# 커스텀 파이프라인 불러오기 및 등록하기

디퓨저스는 [공식 커뮤니티 파이프라인](https://github.com/huggingface/diffusers/tree/main/examples/community)과 커스텀 파이프라인를 지원하고 있습니다. [`DiffusionPipeline`] 클래스를 통해 허깅페이스 허브에 등록된 커스텀 파이프라인 또한 손쉽게 불러올 수 있습니다.



## 허브를 통해 커스텀 파이프라인 불러오기

커스텀 파이프라인의 경우, 허깅페이스 허브를 통해 손쉽게 불러올 수 있습니다. 허브에 등록된 모델들의 레포지토리를 확인해보면 `pipeline.py`라는 파일을 통해 디퓨전 파이프라인을 정의하고 있다는 것을 알 수 있습니다. 한번  [hf-internal-testing/diffusers-dummy-pipeline](https://huggingface.co/hf-internal-testing/diffusers-dummy-pipeline)이라는 더미 파이프라인을 로드해보겠습니다.

커스텀 파이프라인을 불러오기 위해서는 `custom_pipeline`이라는 인자에 해당 파이프라인의 레포지토리 ID(`"hf-internal-testing/diffusers-dummy-pipeline"`)를 전달하기만 하면 됩니다. 

```python
from diffusers import DiffusionPipeline

pipeline = DiffusionPipeline.from_pretrained(
    "google/ddpm-cifar10-32", custom_pipeline="hf-internal-testing/diffusers-dummy-pipeline"
)
```

위의 코드는 [해당 모델의 레포지토리](https://huggingface.co/hf-internal-testing/diffusers-dummy-pipeline/blob/main/pipeline.py)에 정의된 커스텀 파이프라인을 불러옵니다.



<Tip warning={true} >

허깅페이스 허브로부터 커스텀 파이프라인을 불러오기 앞서, 반드시 해당 파이프라인의 코드가 안전한지 그리고 신뢰할 수 있는지를 체크해야 합니다. 

</Tip>



## 공식 커뮤니티 파이프라인 불러오기

커뮤니티 파이프라인들은 [community examples folder](https://github.com/huggingface/diffusers/tree/main/examples/community)에서 확인할 수 있습니다.  

불러오고자 하는 커뮤니티 파이프라인의 파일이름을  `custom_pipeline` 인자에 전달합니다. 단, 여기서 파일이름에 `.py` 확장자는 제거해야 합니다. 예: [`"clip_guided_stable_diffusion"`](https://github.com/huggingface/diffusers/blob/main/examples/community/clip_guided_stable_diffusion.py)



커뮤니티 파이프라인을 불러오는 과정은 보다 복잡하게 진행될 수 있는데, 다음과 같이 `clip_model`과 `feature_extractor`를 따로 인스턴스화 한 다음, 파이프라인 모듈에 전달할 수 있습니다.

```python
from diffusers import DiffusionPipeline
from transformers import CLIPFeatureExtractor, CLIPModel

clip_model_id = "laion/CLIP-ViT-B-32-laion2B-s34B-b79K"

feature_extractor = CLIPFeatureExtractor.from_pretrained(clip_model_id)
clip_model = CLIPModel.from_pretrained(clip_model_id)

pipeline = DiffusionPipeline.from_pretrained(
    "runwayml/stable-diffusion-v1-5",
    custom_pipeline="clip_guided_stable_diffusion",
    clip_model=clip_model,
    feature_extractor=feature_extractor,
)
```





## 허깅페이스 허브에 커스텀 파이프라인 등록하기

커스텀 파이프라인을 허깅페이스 허브에 등록하기 위해서는, `pipeline.py` 파일에 [`DiffusionPipeline`]를 상속받은 파이프라인 클래스를 정의해야 합니다. 전체 파이프라인은 하나의 클래스 내에서 캡슐화 되어야 하며 `pipeline.py` 파일은 딱 그 클래스만을 갖고 있어야 합니다.



예시를 봅시다.


```python
import torch
from diffusers import DiffusionPipeline


class MyPipeline(DiffusionPipeline):
    def __init__(self, unet, scheduler):
        super().__init__()

    self.register_modules(unet=unet, scheduler=scheduler)

    @torch.no_grad()
    def __call__(self, batch_size: int = 1, num_inference_steps: int = 50):
        # Sample gaussian noise to begin loop
        image = torch.randn((batch_size, self.unet.in_channels, self.unet.sample_size, self.unet.sample_size))

        image = image.to(self.device)

        # set step values
        self.scheduler.set_timesteps(num_inference_steps)

        for t in self.progress_bar(self.scheduler.timesteps):
            # 1. predict noise model_output
            model_output = self.unet(image, t).sample

            # 2. predict previous mean of image x_t-1 and add variance depending on eta
            # eta corresponds to η in paper and should be between [0, 1]
            # do x_t -> x_t-1
            image = self.scheduler.step(model_output, t, image, eta).prev_sample

        image = (image / 2 + 0.5).clamp(0, 1)
        image = image.cpu().permute(0, 2, 3, 1).numpy()

        return image
```



`pipeline.py` 파일의 작성을 완료했으면, 해당 파일을 [모델 레포지토리](https://huggingface.co/docs/hub/models-uploading)에 업로드할 수 있습니다. 또한 개인이 아닌 [커뮤니티 조직(organization)](https://huggingface.co/organizations/sd-diffusers-pipelines-library/share/BUPyDUuHcciGTOKaExlqtfFcyCZsVFdrjr)에 가입하여 해당 조직의 이름으로 업로드하는 것도 가능합니다.



끝으로, 모델 레포지토리 이름을 통해 커스텀 파이프라인을 불러올 수 있습니다.

```python
my_pipeline = DiffusionPipeline.from_pretrained(
    "google/ddpm-cifar10-32", custom_pipeline="patrickvonplaten/my_custom_pipeline"
)
```
